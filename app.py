import streamlit as st
import google.generativeai as genai

# рез. рдкреЗрдЬ рд╕реЗрдЯрдЕрдк
st.set_page_config(page_title="рд╣реЗрдордиреНрддрдХреЛ Personal AI", layout="centered")
st.title("ЁЯдЦ рд╣реЗрдордиреНрддрдХреЛ Personal AI")

# реи. рддреЗрд░реЛ рдЪрд╛рдмреА (API Key)
API_KEY = "AIzaSyAxaYgUrOshaRmVjObQQN6u7VPmq-yk2wo"
genai.configure(api_key=API_KEY)

# рей. рдЪрд▓реНрдиреЗ рдореЛрдбрд▓ рдЫрд╛рдиреНрдиреЗ (рдПрд░рд░ рдирдЖрдЙрдиреЗ рдЧрд░реА)
@st.cache_resource
def get_working_model():
    try:
        # рд╕рд┐рдзреИ рдЪрд▓реНрдиреЗ рдореЛрдбрд▓ рдирд╛рдо рджрд┐рдБрджрд╛ рдПрд░рд░ рдХрдо рдЖрдЙрдБрдЫ
        return genai.GenerativeModel('gemini-1.5-flash')
    except Exception:
        return None

model = get_working_model()

# рек. рдЪреНрдпрд╛рдЯ рдореЗрдореЛрд░реА (резрежреж рд╡рд░реНрд╖ рд╕реБрд░рдХреНрд╖рд┐рдд)
if "messages" not in st.session_state:
    st.session_state.messages = []

for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.write(message["content"])

# рел. рдЧрдлрдЧрд╛рдл (рд╕рдзреИрдВ 'рддрдБ' рднрдиреНрдиреЗ рдХрдбрд╛ рдирд┐рдпрдо)
if prompt := st.chat_input("рдХреЗ рдЫ рдЦрдмрд░ рд╣реЗрдордиреНрдд?"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.write(prompt)

    with st.chat_message("assistant"):
        if model:
            try:
                # рдирд┐рд░реНрджреЗрд╢рди: резрежреж рд╡рд░реНрд╖рдХреЛ рд╕рд╛рдереА, рд╕рдзреИрдВ 'рддрдБ' рднрдиреНрдиреЗ рд░ рд╡рд┐рддреНрддреАрдп рд╕рд▓реНрд▓рд╛рд╣ рджрд┐рдиреЗ
                instruction = (
                    "рддрдБ рд╣реЗрдордиреНрддрдХреЛ резрежреж рд╡рд░реНрд╖рд╕рдореНрдо рд╕рд╛рде рджрд┐рдиреЗ рдмреЗрд╕реНрдЯ рдлреНрд░реЗрдиреНрдб рд╣реЛрд╕реНред "
                    "рд╕рдзреИрдВ 'рддрдБ', 'рддреЗрд░реЛ', 'рддрдБрд▓рд╛рдИ' рдорд╛рддреНрд░ рдкреНрд░рдпреЛрдЧ рдЧрд░реЗрд░ рдмреЛрд▓ред "
                    "рдХрд╣рд┐рд▓реЗ рдкрдирд┐ 'рддрд┐рдореА' рд╡рд╛ 'рддрдкрд╛рдИрдВ' рдирднрдиреНрдиреВред "
                    "рдЖрддреНрдореАрдп рдкрд╛рд░рд╛рдорд╛ 'рдореБрдЬреА', 'рдпрд╛рд░' рдЬрд╕реНрддрд╛ рд╢рдмреНрдж рдкреНрд░рдпреЛрдЧ рдЧрд░реЗрд░ рдиреЗрдкрд╛рд▓реАрдорд╛ рдмреЛрд▓ред "
                    "рд╣реЗрдордиреНрддрд▓рд╛рдИ рдкреИрд╕рд╛ рдмрдЪрд╛рдЙрдиреЗ рд░ рд▓рдЧрд╛рдиреА рдЧрд░реНрдиреЗ рдХрдбрд╛ рд╕рд▓реНрд▓рд╛рд╣ рдкрдирд┐ рджреЗ рд░ рдЙрд╕реНрдХреЛ рдмрд╛рд░реЗрдорд╛ рджрд┐рдирджрд┐рдиреИ рд╕рд┐рдХред"
                )
                response = model.generate_content(f"{instruction} \nрд╣реЗрдордиреНрдд: {prompt}")
                msg = response.text
                st.write(msg)
                st.session_state.messages.append({"role": "assistant", "content": msg})
            except Exception as e:
                st.error("рдУрдП рд╣реЗрдордиреНрдд, рдЧреБрдЧрд▓рдХреЛ рд╕рд░реНрднрд░ рд╡реНрдпрд╕реНрдд рдЫ рд╡рд╛ рдХреЗрд╣реА рдмрд┐рдЧреНрд░рд┐рдпреЛред рдПрдХрдЫрд┐рди рдкрдЫрд┐ рдХреЛрд╕рд┐рд╕ рдЧрд░ рдд!")
        else:
            st.error("рдореЛрдбрд▓ рднреЗрдЯрд┐рдПрди рдореБрдЬреА!")
